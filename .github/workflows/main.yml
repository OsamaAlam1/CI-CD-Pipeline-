name: Main CI/CD Pipeline

on:
  push:
    branches:
      - main   # trigger on main branch

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

    steps:
      # 1️⃣ Checkout
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3️⃣ Login to ECR
      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v1

      # 4️⃣ Build Frontend Image
      - name: Build Frontend Image
        run: |
          docker build -t frontend-app ./client
          docker tag frontend-app:latest $ECR_REGISTRY/frontend-app:latest

      # 5️⃣ Build Backend Image
      - name: Build Backend Image
        run: |
          docker build -t backend-app ./server
          docker tag backend-app:latest $ECR_REGISTRY/backend-app:latest

      # 6️⃣ Push Images
      - name: Push Images to ECR
        run: |
          docker push $ECR_REGISTRY/frontend-app:latest
          docker push $ECR_REGISTRY/backend-app:latest

      # 7️⃣ Deploy to EC2
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |

            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
            ECR_REGISTRY=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

            # Login to ECR on EC2
            aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin $ECR_REGISTRY

            mkdir -p ~/3tier-app
            cd ~/3tier-app

            docker pull $ECR_REGISTRY/frontend-app:latest
            docker pull $ECR_REGISTRY/backend-app:latest

            # Create docker-compose.yml dynamically
            cat > docker-compose.yml <<EOF
version: '3.8'

services:
  mongo:
    image: mongo:6
    container_name: mongo
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  backend:
    image: $ECR_REGISTRY/backend-app:latest
    container_name: backend
    restart: always
    ports:
      - "8000:8000"
    environment:
      - MONGODB_URI=mongodb://mongo:27017/mydb
    depends_on:
      - mongo

  frontend:
    image: $ECR_REGISTRY/frontend-app:latest
    container_name: frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mongo_data:
EOF

            docker compose down || true
            docker compose up -d
